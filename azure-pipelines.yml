trigger:
  branches:
    include:
      - main

variables:
  acrLoginServer: 'billingappacr01.azurecr.io'
  imageName: 'billing-app'

stages:

# ================================
# STAGE 1: BUILD & TEST
# ================================
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: BuildTest
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: 'Install Node.js'

    - script: npm install
      displayName: 'Install Dependencies'

    - script: npx jest --passWithNoTests
      displayName: 'Run Tests'

# ================================
# STAGE 2: SECURITY SCAN
# ================================
- stage: SecurityScan
  displayName: 'Security Scan using Trivy'
  dependsOn: Build
  jobs:
  - job: TrivyScan
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    - script: |
        docker build -t $(imageName):$(Build.BuildId) .
      displayName: 'Build Docker Image for Scan'

    - script: |
        sudo apt-get update
        sudo apt-get install -y wget apt-transport-https gnupg
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy
      displayName: 'Install Trivy'

    - script: |
        trivy image --exit-code 0 --severity HIGH,CRITICAL $(imageName):$(Build.BuildId)
      displayName: 'Run Trivy Scan'

# ================================
# STAGE 3: BUILD AMD64 & PUSH TO ACR
# ================================
- stage: Containerize
  displayName: 'Build AMD64 Image & Push to ACR'
  dependsOn: SecurityScan
  jobs:
  - job: PushACR
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    - task: Docker@2
      inputs:
        containerRegistry: 'ACRServiceConnection'
        command: 'login'

    - script: |
        docker buildx create --use
        docker buildx inspect --bootstrap
      displayName: 'Enable Docker Buildx'

    - script: |
        docker buildx build \
        --platform linux/amd64 \
        -t billingappacr01.azurecr.io/billing-app:$(Build.BuildId) \
        -t billingappacr01.azurecr.io/billing-app:latest \
        --push .
      displayName: 'Build AMD64 Image & Push to ACR'

# ================================
# STAGE 4: DEPLOY TO AKS
# ================================
- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Containerize
  jobs:
  - job: DeployAKS
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    - task: KubernetesManifest@1
      displayName: 'Deploy to AKS'
      inputs:
        action: 'deploy'
        kubernetesServiceConnection: 'AKSServiceConnection'
        namespace: 'default'
        manifests: |
          k8s/deployment.yaml
        containers: |
          billingappacr01.azurecr.io/billing-app:$(Build.BuildId)