trigger:
  branches:
    include:
      - main

variables:
  acrName: 'billingappacr01'
  acrLoginServer: 'billingappacr01.azurecr.io'
  imageName: 'billing-app'
  aksCluster: 'billing-aks'
  resourceGroup: 'Tamil-RG'

stages:

# ================================
# STAGE 1: BUILD & TEST
# ================================
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: BuildTest
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    - task: NodeTool@0
      inputs:
        versionSpec: '18.x'
      displayName: 'Install Node.js'

    - script: npm install
      displayName: 'Install Dependencies'

    - script: chmod +x node_modules/.bin/jest
      displayName: 'Fix Jest Permission'

    - script: ./node_modules/.bin/jest --passWithNoTests
      displayName: 'Run Tests'


# ================================
# STAGE 2: SECURITY SCAN (TRIVY)
# ================================
- stage: SecurityScan
  displayName: 'Security Scan using Trivy'
  dependsOn: Build
  jobs:
  - job: TrivyScan
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    - script: |
        docker build -t $(imageName):$(Build.BuildId) .
      displayName: 'Build Docker Image for Scan'

    - script: |
        sudo apt-get update
        sudo apt-get install -y wget apt-transport-https gnupg
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy
      displayName: 'Install Trivy'

    - script: |
        trivy image --exit-code 0 --severity HIGH,CRITICAL $(imageName):$(Build.BuildId)
      displayName: 'Run Trivy Scan'


# ================================
# STAGE 3: PUSH TO ACR
# ================================
- stage: Containerize
  displayName: 'Build & Push Image to ACR'
  dependsOn: SecurityScan
  jobs:
  - job: PushACR
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    - task: Docker@2
      displayName: 'Build and Push Image to ACR'
      inputs:
        command: 'buildAndPush'
        containerRegistry: 'ACRServiceConnection'
        repository: '$(imageName)'
        dockerfile: 'Dockerfile'
        tags: |
          $(Build.BuildId)
          latest


# ================================
# STAGE 4: DEPLOY TO AKS
# ================================
- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Containerize
  jobs:
  - job: DeployAKS
    pool:
      vmImage: 'ubuntu-latest'
    steps:

    # FIX ImagePullBackOff Automatically
    - task: AzureCLI@2
      displayName: 'Attach ACR to AKS'
      inputs:
        azureSubscription: 'AzureRMConnection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az aks update \
            --name $(aksCluster) \
            --resource-group $(resourceGroup) \
            --attach-acr $(acrName)

    #  Deploy App to AKS
    - task: KubernetesManifest@0
      displayName: 'Deploy to AKS'
      inputs:
        action: 'deploy'
        kubernetesServiceConnection: 'AKSServiceConnection'
        namespace: 'default'
        manifests: 'k8s/deployment.yaml'
        containers: '$(acrLoginServer)/$(imageName):$(Build.BuildId)'